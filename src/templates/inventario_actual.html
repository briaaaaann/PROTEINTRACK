<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventario en Tiempo Real - ProteinTrack</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- ESTILOS VISUALES (INTEGRADOS) --- */
        :root {
            --primary: #2c3e50;
            --accent: #8e44ad; /* MORADO INVENTARIO */
            --bg: #f0f2f5;
            --card-bg: #ffffff;
            --text: #333;
            --border: #ddd;
            
            /* Colores de Sem치foro */
            --stock-ok: #27ae60;
            --stock-low: #f39c12;
            --stock-crit: #c0392b;
        }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            margin: 0;
            padding: 20px;
            color: var(--text);
            min-height: 100vh;
        }

        .main-container {
            width: 100%;
            max-width: 1000px; /* Ancho amplio para la tabla */
            margin: 0 auto;
        }

        /* Bot칩n Volver */
        .btn-back {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            color: #666;
            font-weight: 600;
            margin-bottom: 20px;
            transition: color 0.3s;
        }
        .btn-back:hover { color: var(--accent); }

        /* Tarjeta Principal */
        .content-card {
            background-color: var(--card-bg);
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.05);
            border-top: 5px solid var(--accent);
        }

        .header-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .header-title h1 { margin: 0; font-size: 1.8rem; color: var(--accent); }
        .header-title p { margin: 5px 0 0 0; color: #7f8c8d; font-size: 0.95rem; }

        /* --- BARRA DE HERRAMIENTAS (Filtros y Buscador) --- */
        .toolbar {
            display: flex;
            gap: 15px;
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 12px;
            border: 1px solid #e9ecef;
            flex-wrap: wrap;
            align-items: center;
        }

        .search-wrapper {
            flex-grow: 1; /* Ocupa el espacio disponible */
            position: relative;
            min-width: 250px;
        }
        .search-wrapper i {
            position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #95a5a6;
        }
        .form-control {
            width: 100%; padding: 10px 10px 10px 35px; /* Espacio para icono */
            border: 1px solid #ced4da; border-radius: 8px; font-size: 0.95rem;
            box-sizing: border-box;
        }
        .form-control:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px rgba(142, 68, 173, 0.1); }

        .filter-select {
            padding: 10px; border-radius: 8px; border: 1px solid #ced4da;
            background-color: white; color: var(--primary); min-width: 150px;
        }

        /* Botones de Ordenar (Peque침os y elegantes) */
        .sort-btn {
            background-color: white; border: 1px solid #ced4da; color: var(--primary);
            padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 0.9rem;
            display: flex; align-items: center; gap: 6px; transition: all 0.2s;
        }
        .sort-btn:hover { background-color: #e9ecef; color: var(--accent); }
        .sort-btn.active { background-color: var(--accent); color: white; border-color: var(--accent); }

        /* --- TABLA MODERNA --- */
        .table-responsive {
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid #eee;
        }

        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        
        thead { background-color: var(--primary); color: white; }
        th { padding: 15px; text-align: left; font-weight: 500; letter-spacing: 0.5px; }
        
        td { padding: 12px 15px; border-bottom: 1px solid #f1f1f1; color: var(--text); vertical-align: middle; }
        tr:hover td { background-color: #f8f9fa; }
        tr:last-child td { border-bottom: none; }

        /* --- SEM츼FOROS DE STOCK (BADGES) --- */
        .stock-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-weight: 700;
            font-size: 0.9rem;
            text-align: center;
            min-width: 60px;
        }

        /* Clases generadas por tu JS, ahora estilizadas */
        .stock-positivo { 
            background-color: rgba(39, 174, 96, 0.15); color: var(--stock-ok); 
        }
        .stock-bajo { 
            background-color: rgba(243, 156, 18, 0.15); color: var(--stock-low); 
        }
        .stock-negativo { 
            background-color: rgba(192, 57, 43, 0.15); color: var(--stock-crit); 
            box-shadow: 0 0 5px rgba(192, 57, 43, 0.2);
        }

        /* Texto peque침o para familia */
        .familia-tag {
            background-color: #ecf0f1; color: #7f8c8d;
            padding: 2px 8px; border-radius: 4px; font-size: 0.8rem;
        }
        
    </style>
</head>
<body>

    <div class="main-container">
        
        <a href="/" class="btn-back">
            <i class="fas fa-arrow-left"></i> Volver al Men칰
        </a>

        <div class="content-card">
            
            <div class="header-section">
                <div class="header-title">
                    <h1><i class="fas fa-boxes"></i> Inventario Actual</h1>
                    <p>Visualizando solo productos de <strong>Producci칩n Interna</strong></p>
                </div>
            </div>

            <div class="toolbar">
                <div class="search-wrapper">
                    <i class="fas fa-search"></i>
                    <input type="text" id="buscador" class="form-control" placeholder="Buscar producto...">
                </div>

                <select id="filtro-familia" class="filter-select">
                    <option value="">Todas las Familias</option>
                    </select>

                <div style="display: flex; gap: 5px;">
                    <button id="btn-orden-nombre" class="sort-btn active" title="Ordenar por Nombre">
                        <i class="fas fa-sort-alpha-down"></i> A-Z
                    </button>
                    <button id="btn-orden-stock" class="sort-btn" title="Ordenar por Cantidad">
                        <i class="fas fa-sort-numeric-down"></i> Stock
                    </button>
                </div>
            </div>

            <br>

            <div class="table-responsive">
                <table>
                    <thead>
                        <tr>
                            <th>Producto</th>
                            <th>Stock Actual</th>
                            <th>Unidad</th>
                            <th>Familia</th>
                        </tr>
                    </thead>
                    <tbody id="tabla-body">
                        <tr><td colspan="4" style="text-align:center; padding: 20px;">Cargando inventario...</td></tr>
                    </tbody>
                </table>
            </div>

        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            
            const API_URL = ""; 
            const tablaBody = document.getElementById("tabla-body");
            const buscador = document.getElementById("buscador");
            const filtroFamilia = document.getElementById("filtro-familia");
            const btnOrdenNombre = document.getElementById("btn-orden-nombre");
            const btnOrdenStock = document.getElementById("btn-orden-stock");

            let inventarioCompleto = [];
            let criterioOrden = "nombre"; // 'nombre' | 'stock'

            // --- Cargar Datos ---
            async function cargarInventario() {
                try {
                    const response = await fetch(`${API_URL}/api/productos`);
                    if (!response.ok) throw new Error("Error al obtener inventario");
                    
                    const productos = await response.json();
                    
                    // =========================================================
                    // 游띔 FILTRO MAESTRO: SOLO PRODUCTOS DE PRODUCCI칍N
                    // =========================================================
                    const soloProduccion = productos.filter(p => p.es_registrable_produccion);

                    // Mapeamos para tener una estructura limpia
                    inventarioCompleto = soloProduccion.map(p => ({
                        nombre: p.nombre,
                        stock_convertido: parseFloat(p.stock_convertido || 0),
                        unidad_nombre: p.unidad_nombre || 'u',
                        familia_nombre: p.familia_nombre || 'Sin Familia'
                    }));

                    llenarFiltroFamilias();
                    aplicarFiltrosYRenderizar();

                } catch (error) {
                    console.error(error);
                    tablaBody.innerHTML = `<tr><td colspan='4' style='color:red; text-align:center'>Error cargando datos: ${error.message}</td></tr>`;
                }
            }

            // --- Llenar Select de Familias ---
            function llenarFiltroFamilias() {
                const familias = [...new Set(inventarioCompleto.map(p => p.familia_nombre))].sort();
                filtroFamilia.innerHTML = "<option value=''>Todas las Familias</option>";
                familias.forEach(fam => {
                    const opt = document.createElement("option");
                    opt.value = fam;
                    opt.textContent = fam;
                    filtroFamilia.appendChild(opt);
                });
            }

            // --- Filtrado y Orden ---
            function aplicarFiltrosYRenderizar() {
                const texto = buscador.value.toLowerCase();
                const familiaSel = filtroFamilia.value;

                // 1. Filtrar
                let listaFiltrada = inventarioCompleto.filter(p => {
                    const coincideTexto = p.nombre.toLowerCase().includes(texto);
                    const coincideFamilia = familiaSel === "" || p.familia_nombre === familiaSel;
                    return coincideTexto && coincideFamilia;
                });

                // 2. Ordenar
                listaFiltrada.sort((a, b) => {
                    if (criterioOrden === "stock") {
                        return a.stock_convertido - b.stock_convertido; // Menor a mayor (urgencias)
                    } else {
                        // Por nombre
                        const valA = a.nombre.toLowerCase();
                        const valB = b.nombre.toLowerCase();
                        if (valA < valB) return -1;
                        if (valA > valB) return 1;
                        return 0;
                    }
                });

                renderizarTabla(listaFiltrada);
            }

            // --- Renderizado Visual ---
            function renderizarTabla(lista) {
                tablaBody.innerHTML = "";

                if (lista.length === 0) {
                    tablaBody.innerHTML = "<tr><td colspan='4' style='text-align:center; padding:20px; color:#7f8c8d;'>No hay productos de producci칩n que coincidan.</td></tr>";
                    return;
                }
                
                lista.forEach(p => {
                    // L칩gica de sem치foro
                    let claseStock = "stock-positivo";
                    const stockVal = p.stock_convertido;
                    
                    if (stockVal <= 0) claseStock = "stock-negativo";
                    else if (stockVal < 5) claseStock = "stock-bajo"; 

                    const tr = document.createElement("tr");
                    
                    tr.innerHTML = `
                        <td><strong>${p.nombre}</strong></td>
                        <td><span class="stock-badge ${claseStock}">${stockVal.toFixed(2)}</span></td>
                        <td style="color:#555;">${p.unidad_nombre}</td>
                        <td><span class="familia-tag">${p.familia_nombre}</span></td>
                    `;
                    tablaBody.appendChild(tr);
                });
            }

            // --- Event Listeners ---
            buscador.addEventListener("input", aplicarFiltrosYRenderizar);
            filtroFamilia.addEventListener("change", aplicarFiltrosYRenderizar);

            btnOrdenNombre.addEventListener("click", () => {
                criterioOrden = "nombre";
                btnOrdenNombre.classList.add("active");
                btnOrdenStock.classList.remove("active");
                aplicarFiltrosYRenderizar();
            });

            btnOrdenStock.addEventListener("click", () => {
                criterioOrden = "stock";
                btnOrdenStock.classList.add("active");
                btnOrdenNombre.classList.remove("active");
                aplicarFiltrosYRenderizar();
            });

            // Iniciar
            cargarInventario();
        });
    </script>
</body>
</html>